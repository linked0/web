â€»ğŸŒŸğŸ“ğŸ¦‹âš¾ï¸ğŸ¥ğŸğŸ³ğŸ€ğŸŒ¼ğŸŒ¸ğŸ†ğŸœğŸ˜ˆğŸ¹ğŸ¦ğŸŒŸğŸ”¹â™¦ï¸âš¡ï¸ğŸ’¥ğŸŒˆğŸ”¥âš¾ï¸ğŸ¶ğŸ¦„â˜•ï¸ğŸš˜ğŸ”´â€»
### 0 ê¸°ë³¸ ì„¸íŒ…
= ubuntu ë²„ì „ì€ 22.04 ì´ìƒ
ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-20230325
= .gitconfigì— web/sub/gitconfig-aws ë‚´ìš©ì„ ë³µì‚¬
= aws security settings
SSH, EL-RPC, CL-NODE, EL-NODE

= make
sudo apt-get update
sudo apt-get install make

= git update
sudo add-apt-repository ppa:git-core/ppa
sudo apt-get update
sudo apt-get install git

= docker
1) Set up Docker's apt repository.
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
2) Install the Docker packages.
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

3) Verify that the Docker Engine installation
sudo docker run hello-world

4) Docker daemon socket Permission
sudo gpasswd -a $USER docker
sudo systemctl restart docker
(ë¨¸ì‹  ë¦¬ë¶€íŒ…)

= gcc & g++ ì„¤ì¹˜
í˜„ì¬ ì„¤ì¹˜ë˜ì–´ ìˆëŠ” ê²ƒì€(3.37.37.195) 11.4.0
sudo apt install gcc
sudo apt install g++

= go (go1.21.0)
sudo rm -rf /usr/bin/go
sudo rm -rf /usr/local/go
wget https://go.dev/dl/go1.21.0.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
add â€œexport PATH=$PATH:/usr/local/go/bin:$HOME/go/binâ€ to ./bashrc

= nvm install & use
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.4/install.sh | bash
source ~/.bashrc  
nvm install 16 && nvm use 16
npm install -g npm@9.8.1 @bazel/bazelisk

= python 3.10 env
python3 ë²„ì „í™•ì¸í•˜ê³  3.10 ì„¤ì¹˜
sudo apt install python3.10 (brew install python@3.10)
sudo apt install python3-dev
sudo apt install python3.10-venv
python3.10 -m venv deposit-venv

= install "zcli"
go install github.com/protolambda/zcli@latest

= poohgeth compile
./compile

= poohprysm compile (ì‹¤íŒ¨í•˜ë©´ ë‹¤ì‹œ ì»´íŒŒì¼)
bazel build //cmd/beacon-chain:beacon-chain --config=release
bazel build //validator:image_bundle --config=release

### 1. gethë¥¼ ìƒˆë¡œìš´ configë¡œ ì‹¤í–‰
= ./init testnet 1 & ./enode-cmdìœ¼ë¡œ ì‹¤í–‰í•˜ê¸°
= ì¼ë‹¨ ì´ê²ƒìœ¼ë¡œ ì„¤ê³µì„ í•˜ë©´ ì¼ë‹¨ ëŒì§€ ì•Šê³ ì„œ ëŒ€ê¸°í•˜ê³  ìˆì„ ê²ƒì„

### 2.  chain-config.yaml ìˆ˜ì •í•˜ê³  genesis íŒŒì¼ ë§Œë“¤ê¸°
= ëª¨ë“  ìˆ˜ì •ì€, ë‚´ ë¡œì»¬ ë¨¸ì‹ ì—ì„œ, ìƒˆë¡œ ë”´ ë¸Œëœì¹˜ì—ì„œ ìˆ˜ì •í•˜ê³  ëª¨ë“  ë¨¸ì‹ ì—ì„œ ì—…ë°ì´íŠ¸í•˜ëŠ” ë°©ì‹(ë¸Œëœì¹˜ì˜ˆ: el-friday)
= TERMINAL_BLOCK_HASH ì§€ì •
"hash"ìŠ¤í¬ë¦½íŠ¸ë¡œ "hash" í•­ëª©ì„ ê°€ì ¸ì˜´.
ì–´ì§œí”¼ ê³ ì •ëœ ì„¸íŒ…ì„ ì‚¬ìš©í•˜ë¯€ë¡œ, ë°”ë€Œì§€ ì•ŠìŒ. ë…¸ë“œí‚¤ê°€ ë‹¬ë¼ì§€ë©´ ë°”ë€”ìˆ˜ ìˆì§€ë§Œ, ì´ˆê¸°ì„¸íŒ…ì€ ë˜‘ê°™ì€ ì„¤ì •ì„ ì‚¬ìš©í•¨.
= MIN_GENESIS_ACTIVE_VALIDATOR_COUNT: 8
= MIN_GENESIS_TIME: ì›í•˜ëŠ” consensus layer genesis time
    - date +%sìœ¼ë¡œ í˜„ì¬ ì‹œê°„ì„ ì–»ì–´ì™€ì„œ í•œ 600(10ë¶„)ì„ ë”í•œë‹¤.
    - ğŸ”¥ í•œë²ˆ ì„¸íŒ…ì´ ëœ í›„ì— ë‹¤ì‹œ ì—¬ëŸ¬ë²ˆ ì‹œë„í• ë•Œ ì´ ë¶€ë¶„ë§Œ ì„¸íŒ…í•˜ê¸° ë‹¤ì‹œ í•˜ë©´ë¨
= SHARDING_FORK_VERSION, SHARDING_FORK_EPOCH ì£¼ì„ ì²˜ë¦¬í•¨

= geth2-testnet-genesis ë¹Œë“œ: ./gen-binary
= genesis.ssz ìƒì„±: ./gen_genesis
    - ì´ë¶€ë¶„ì€ ê±°ì˜ ë°”ë€” ì¼ ì—†ìŒ, ê°™ì€ mnemonic ì“°ê¸° ë•Œë¬¸.
= Genesis Validators Root ì°¾ì•„ì„œ setting.pyì— ì¶”ê°€
    - get "Genesis Validators Root" with following command on "poohnet" folder.
    - zcli pretty bellatrix  BeaconState config/genesis.ssz > parsedState.json
    - find "genesis_validators_root" on "parsedState.json" file
    - copy the value of "genesis_validators_root" to the following part of setting.py
ë°”ë€ŒëŠ” ê²ƒì´ ê±°ì˜ ì—†ìŒ. ê°™ì€ mnemonic ì“°ê¸° ë•Œë¬¸.
    - vi ./poohnet/pooh-deposit-cli/staking_deposit/settings.py
    TestnetSetting = BaseChainSetting(
    NETWORK_NAME=TESTNET, GENESIS_FORK_VERSION=bytes.fromhex('2F1C0000'),
    GENESIS_VALIDATORS_ROOT=bytes.fromhex('e63460dc044e056f26ca8f7406a18867d31f1ec195322f428b5918d4b0153050'))

### 3. staking-deposit-cli
= run "stake" command
    - ì´ë¯¸ ìƒì„±ëœ í‚¤ íŒŒì¼ë“¤ì´ ìˆìœ¼ë©´ ./keysë¡œ í‚¤ë§Œ ë³µì‚¬: í‚¤ ë³µì‚¬ (ì•”í˜¸:pooh2023!@)
= run "password": sudo vi ~/.pooh/cl/config/password.txt, ì•”í˜¸ ì¶”ê°€

### 4. cl & vals ì‹¤í–‰
= cnodeê°€ ìµœì†Œ 3ê°œëŠ” ì‹¤í–‰ë˜ì–´ì•¼ í•¨.("at least two peered beacon nodes")
= ë¨¸ì‹ ì„ ì¬ë¶€íŒ…í•˜ê³  ì‹¤í–‰í•˜ê³  ì²˜ìŒ ì‹¤í–‰ì‹œí‚¬ë•Œ ì²´í¬í•˜ëŠ” ê³¼ì •ì´ ë§¤ìš° ì˜¤ë˜ ê±¸ë¦¼.
= ì²«ë²ˆì§¸ ë¨¸ì‹ ì—ì„œ cl ì‹¤í–‰: ./cnode
= ì²«ë²ˆì§¸ clì˜ enrì„ ì•Œì•„ë‚´ì„œ ë‹¤ë¥¸ cnode ìŠ¤í¬ë¦½íŠ¸ì˜ bootstrap-node í•­ëª©ì— ì„¸íŒ…í•˜ê¸°
= ë‘ë²ˆì§¸ ë¨¸ì‹ ì—ì„œ cl ì‹¤í–‰: ./cnode
= ì²«ë²ˆì§¸ ë¨¸ì‹ ì´ validatorì´ë¯€ë¡œ ì‹¤í–‰: ./validators
= cnodeì— ì´ ë©”ì‹œì§€ê°€ ëœ¨ëŠ”ì§€ í™•ì¸: INFO p2p: Peer summary activePeers=1 inbound=1 outbound=0
= validatorì—ì„œ ì´ ë©”ì‹œì§€ í™•ì¸: INFO validator: Waiting for beacon node to sync to latest chain head

### 5. ì‚´í´ë³¼ ë©”ì‹œì§€ on cnode
= ê¸°íƒ€: git reset --hard origin/set-cl-node, git reset --hard origin/pos
= Trouble Shooting: https://docs.prylabs.network/docs/troubleshooting/issues-errors
= INFO slotutil: 4m10s until chain genesis genesisStateRoot=0b6a76b8a59b6a65b9accbb90f556fad77af865c2fe23745a0421f6157ed3751 genesisTime=2024-07-02 03:29:20 +0000 UTC genesisValidators=8
=  INFO p2p: Peer summary activePeers=0 inbound=0 outbound=0
--> ì´ê±°ëŠ” ë¬¸ì œë¡œ ë³´ì„.
= ì—ëŸ¬ 1
ERROR validator: Failed to request block from beacon node blockSlot=33 error=rpc error: code = Unknown desc = could not build block in parallel: rpc error: code = Internal desc = Could not get local payload: unknown beacon state version pubKey=0x8b439a7aa748
ERROR validator: rpc error: code = Unavailable desc = Syncing to latest head, not ready to respond
= ì—ëŸ¬2: ë‹¤ìŒì˜ ë©”ì‹œì§€ê°€ ì§€ì •ëœ merge íƒ€ì„ì„ ì§€ë‚˜ì„œë„ ë‚˜íƒ€ë‚¨
INFO validator: Waiting for beacon node to sync to latest chain head
--> RPC gateway provider endpointì— í•´ë‹¹í•˜ëŠ” 3500ë²ˆ í¬íŠ¸ê°€ ì—´ë¦¬ì§€ ì•Šì•„ì„œ ê·¸ëŸ°ê²ƒìœ¼ë¡œ íŒë‹¨ë¨
security groupì´ ì ìš©ë˜ê¸° ìœ„í•´ì„œ instance ë‹¤ì‹œ ëŒë¦¼.
= ì—ëŸ¬3: ERROR validator: Failed to request block from beacon node blockSlot=70 error=rpc error: code = Unknown desc = could not build block in parallel: rpc error: code = Internal desc = Could not get local payload: could not prepare payload: payload status is SYNCING or ACCEPTED pubKey=0xaa730e92e28d
--> chain-config.yamlì„ ì ì ˆíˆ ì„¸íŒ…í•˜ì§€ ì•Šì•„ì„œ ë°œìƒí•˜ë˜ ë¬¸ì œë¥¼ í•´ê²°í•˜ì˜€ìœ¼ë‚˜ ìœ„ì™€ ê°™ì€ ë¬¸ì œ ì¶”ê°€ ë°œìƒ
= ì—ëŸ¬4: ERROR rpc/validator: Could not pack deposits and attestations error=context canceled
ERROR p2p: Failed to find peers error=unable to find requisite number of peers for topic /eth2/65c7e087/sync_committee_1/ssz_snappy - only 0 out of 1 peers were able to be found
--> CL_BOOT_NODE security ì„¤ì • ì•ˆí•¨: ì´ëŸ° ì•ˆí•˜ë©´ 4000ë²ˆ í¬íŠ¸ê°€ ì—´ë¦¬ì§€ ì•ŠìŒ


ğŸ€ğŸŒ¼ğŸŒ¸ğŸ†ğŸœğŸ€ğŸŒ¼ğŸŒ¸ğŸ†ğŸ”¹ğŸ€ğŸŒ¼ğŸŒ¸ğŸ†ğŸ€ğŸŒ¼ğŸŒ¸ğŸ†ğŸ€ğŸŒ¼ğŸŒ¸ğŸ†ğŸ€ğŸŒ¼ğŸŒ¸ğŸ†
ğŸ€ğŸŒ¼ğŸŒ¸ğŸ†ğŸœğŸ€ğŸŒ¼ğŸŒ¸ğŸ†ğŸ”¹ğŸ€ğŸŒ¼ğŸŒ¸ğŸ†ğŸ€ğŸŒ¼ğŸŒ¸ğŸ†ğŸ€ğŸŒ¼ğŸŒ¸ğŸ†ğŸ€ğŸŒ¼ğŸŒ¸ğŸ†

# call attack: ë¹¨
- 6. Factory(Ownable/Initializable) - Minimal proxy(eip1167)/Admin Proxy(eip1967) - Beacon Proxy - Implementation(ReentrancyGuard) - Beacon
  -- Potential Solution: OZ "Address" library
    -- isContract, sendValue, functionCall, functionCallWithValue, functionStaticCall, functionDelegateCall etc
    -- ìë™ì ìœ¼ë¡œ revert í•¨.
  -- uint256[50] private __gap; (OpenZepperlin privides)
- 7. DiamondProxy(delegate call) but erc6900(call) due to proxy data security issue
- 8. key cautions: Ensure the storage layout of the new implementation matches the layout of the original.
- 9. Initializable contractë¡œ í•´ê²°ê°€ëŠ¥
- 10. ì•„ì§ ë‚¨ìŒ
- Account existence must be checked prior to calling if needed.
- delegatecall: target contractì—ì„œ msg.senderì™€ msg.valueëŠ” ë°”ë€Œì§€ ì•ŠìŒ.
  -- proxy contractì—ì„œ ì‚¬ìš©ë¨.
  -- MultiSig Wallet, Smart Wallet, Account Abstraction
  -- Bridges & Cross-Chain Messaging
- prxoy: gas saving, upgradability
- Relations among Minimal Clones and other proxies.
- Factory deploy other contracts
- create2 is very inefficient
  -- EIP 1167 is a standard for deploying minimal proxy contracts, also known as "clones".
- Proxy issues
  -- Storage Collisions
  -- Initialization issues: 
  -- Frontrunning issues: intialize function
  -- Key Leakage & Centralization issue

# DAO attack:
1. Beanstalk Hack Case Study, Generally DAO contract derives from ERC20
2. ERC165Checker/Holder, cloneDeterministic
3. @audit-issue

# DOS attack:
1. timeout
4. arrayë¥¼ ë„ˆë¬´ ê¸¸ê²Œ ë§Œë“¤ê¸° 

# Sensitive Data: ê¸ˆ
3. Parent Contractì˜ storage spaceê°€ ìˆœë²ˆì—ì„œ ì•ì„¬
- ì˜ˆë¥¼ ë“¤ì–´ Ownableì´ ìˆìœ¼ë©´ ê·¸ê²ƒì€ storage slotì´ 0ë²ˆì¼ ë†’ìŒ. í˜¹ì€ ReentrancyGuardì˜ _status ë³€ìˆ˜
- Contract Expolerì— ë°°í¬ëœ ì»¨íŠ¸ë™íŠ¸ë¥¼ êµ¬ì¡°ë¥¼ ë³´ë©´ì„œ í™•ì¸ ê°€ëŠ¥.

# 5.unchecked: ì€, ì´ ì€ë„ë¼ê°€ ë„¤ ë„ë¼ëƒ? ì²´í¬í•´ë³´ê³  ì•„ë‹ˆìš” ì² ë„ë¼ê°€ ì œ ë„ë¼ì˜ˆìš”.
1) low-level calls don't revert
- ë˜‘ê°™ì€ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ë„ í•¨ìˆ˜ëª…ìœ¼ë¡œ ì§ì ‘ high level callí•˜ë©´ revertí•¨. ê·¸ëŸ¬ë‚˜ call ê°™ì€ low level callì„ ì“°ë©´ í˜¸ì¶œë°›ëŠ” ìª½ì—ì„œ requireë•Œë¬¸ì— revertê°€ ë°œìƒí•˜ëŠ” ìƒí™©ì´ë¼ë„ revertê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ.
- high level: transfer opcode
- Low-level calls: send, `call`, `delegatecall`, `staticcall`, and `callcode`.
- send() is not an opcode but rather a Solidity member of address type. 
- USDTëŠ” transferì— ëŒ€í•´ì„œ return ì•ˆí•¨.
2) `transfer`: 2300 gas, Automatically reverts on failure.
- `send`: 2300 gas, Returns a boolean indicating success or failure. ì˜ë„ì¹˜ì•Šì€ ì‹¤íŒ¨ ê°€ëŠ¥
- transfer() is not an opcode but rather a Solidity member of address type. 
- transfer() and send() should be avoided (because they take a hard dependency on gas costs by forwarding a fixed amount of gas: 2300).
-  Gas specific code (call{gas: ..., value: ...}("")) should also be avoided.
- call{value: ...}("") should be used, for example: contractB.call{value: 1000}("")
3) SafeERC20 recommand
